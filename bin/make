#!/usr/bin/env bash
set -euo pipefail

dist_dir=dist
char_dir="$dist_dir/char"
sheet_dir="$dist_dir"

# Dump out every character as a 10x bmp _and_ a 10x sheet for for accurate SVG
# tracing and demoing. The bmps use the index 0 background color (without
# transparency) so that should be white for potrace. Also dump out a 10x sprite
# sheet for demos.
aseprite10x() {
  aseprite \
    -b \
    --filename-format "$char_dir/{tag}-10x.bmp" \
    --list-tags \
    --list-slices \
    --inner-padding 10 \
    --sheet-pack \
    --ignore-empty \
    --sheet-type rows \
    --sheet "$sheet_dir/$1-10x.png" \
    --data "$sheet_dir/$1-10x.json" \
    --sheet-columns 16 \
    --sheet-rows 16 \
    "src/$1.aseprite" \
    --scale 10 \
    --save-as "$char_dir/$1-10x.png"
}

# Dump out a 1x sheet.
aseprite1x() {
  aseprite \
  -b \
  --list-tags \
  --list-slices \
  --inner-padding 1 \
  --sheet-pack \
  --sheet-type rows \
  --sheet "$sheet_dir/$1.png" \
  --data "$sheet_dir/$1.json" \
  --sheet-columns 16 \
  --sheet-rows 16 \
  "src/$1.aseprite"
}

rm -rf "$dist_dir"
mkdir -p "$dist_dir" "$char_dir" "$sheet_dir"

cp -a src/*.json "$dist_dir"

for ase in src/*.aseprite; do
  stem="$(basename "$ase" .aseprite)"

  aseprite10x "$stem"
  aseprite1x "$stem"

  for char in "$char_dir/$stem-"*-10x.bmp; do
    # Convert each bmp to an SVG.
    potrace -sa 0 -O 0 -o "${char%.bmp}.svg" "$char"
  done

  bin/fontforge-import \
    "$dist_dir/$stem.sfd" \
    "$dist_dir/$stem.ttf" \
    "$stem" \
    "src/$stem.json" \
    "$char_dir/$stem-"*.svg
done
