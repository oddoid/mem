#!/usr/bin/env sh
# $1 out dir
# $2 xcf
exec gimp -idf "$2" -b '
(let* (
    (img (car (gimp-image-list))) ; $2
    (scale 10)
  )

  ; only the active layer is exported
  (gimp-image-flatten img)

  ; potrace does not trace tiny inputs well
  (gimp-context-set-interpolation INTERPOLATION-NONE)
  (gimp-image-scale
    img
    (* (car (gimp-image-width img)) scale)
    (* (car (gimp-image-height img)) scale))

  ; export a png per guide grid tile
  (python-fu-slice RUN-NONINTERACTIVE img 0 "'"$1"'" "index.htm" "" "png" 0 "" 0 0 0)

  (gimp-quit TRUE)
)
'