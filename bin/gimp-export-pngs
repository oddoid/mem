#!/usr/bin/env sh
export SCALE="$1"
export OUT_DIR="$2"

# when passed as an argument, gimp_image_list() returns an INT32 id but there
# doesn't seem to be a way to get the IMAGE type
export XCF_FILENAME="$3"

gimp --batch-interpreter=python-fu-eval -idfb - << 'eof'

import gimpfu
import os

scale = int(os.environ['SCALE'])
out_dir = os.environ['OUT_DIR']
xcf_filename = os.environ['XCF_FILENAME']

img = pdb.gimp_file_load(xcf_filename, xcf_filename)

layer = pdb.gimp_image_flatten(img)

# potrace does not trace tiny inputs well
pdb.gimp_context_set_interpolation(INTERPOLATION_NONE)
pdb.gimp_image_scale(img, pdb.gimp_image_width(img) * scale,
  pdb.gimp_image_height(img) * scale)

# export a png per guide grid tile
pdb.python_fu_slice(img, layer, out_dir, 'index.htm', '', 'png', 0, '', 0, 0, 0)

pdb.gimp_quit(True)